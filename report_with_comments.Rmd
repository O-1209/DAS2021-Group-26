<<<<<<< HEAD
---
title: "GLM project"
author: "Group 26"
date: "7/19/2021"
output:
  pdf_document:
    latex_engine: pdflatex
    number_sections: yes
    keep_tex: true
  html_document:
    df_print: paged
fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE, comment = NA)
```

```{r libraries,echo = FALSE , include=FALSE, message=FALSE}
library(tidyverse)
library(moderndive)
library(gapminder)
library(sjPlot)
library(stats)
library(jtools)
library(dplyr)
library(tidyr)
library(stringr)
library(purrr)
library(readr)
library(ROCR)
library(lattice)
library(caret)
library(DALEX)
```

```{r data}
#import the data
data <- read.csv("dataset26.csv")
```

# Introduction {#sec:Intro}

The ratings (the number of points awarded for the wine on a scale of 1-100) on a variety of wines are very different, due to many factors, such as different country, price, province, title, variety, winery, etc. This report will present numerical and graphical summaries of properties of wine and use a Generalised Linear Model (GLM) to explore the factors influencing the number of points awarded.

## Data sources & research questions

All the data comes from the WineEnthusiast. In the dataset, 3 explanatory variables were selected to investigate which properties of wine influence whether the number of points awarded is greater than 90. The variables are:

- `country`: country of origin;
- `price`: the cost for a bottle of wine;
- `year`: extract from the `title` of the wine review in Section \ref{sec:EDA}.

Our team select the `bnpoints` as the response variable, which is transformed from the `points` in Section  \ref{sec:EDA}.

# Exploratory Data Analysis {#sec:EDA}

Before starting to analyze the data, we first generate two new variables `year` and `bnpoints` based on the original dataset. Among them, `year` is extracted from the variable `title`, and `bnpoints` is a binary variable. Wines with a score greater than 90 are recorded as 1, and wines with a score less than or equal to 90 are recorded as 0. Next, delete outliers and missing values.

```{r data.processing}
data <- data[,2:8]  #deleting the first line

#glimpse data 
str(data)
# data processing 
# trans to binary
data$bnpoints[data$points > 90] <- 1 
data$bnpoints[data$points <= 90] <- 0
#converting the type of bnpoints to factor
data$bnpoints <- as.factor(data$bnpoints)

#extract year from title
data$year <- data$title
data$year <- str_replace_all(data$year, "[[:punct:]]", " ")
data$year <- str_extract(data$year,"[0-9]{4}") #extracting year with four digits 

#omiting abnormal year
data <- data %>%
  filter(year > 1900)
#converting the type of year from chr. to intger
data$year <- as.integer(data$year)

#omitting the observations with missing variables 
data <- na.omit(data)
```

After removing missing data, there are 1794 types of wine to analyze. In this report, if points is 1, the quality of the wine is Excellent; if points is 0, the quality of the wine is Good. The relationship between points and prices and the relationship between points and years are presented in the following boxplots and scatter plots, respectively.

```{r points.vs.price1}
#The boxplot of points against price
ggplot(data = data, aes(x = bnpoints, y = price, group = bnpoints)) +
  geom_boxplot(fill = c("pink", "yellow")) +
  labs(x = "Points", y = "Price", title = "The boxplot of price grouped by points") + 
  scale_x_discrete("Points", labels = c("0" = "Good", "1" = "Excellent")) +
  theme(legend.position = "none") 
```

The above boxplots show that higher-priced wines are of higher quality, in general, compared to the lower-priced wines and that the prices of wines are widely distributed. There are also potentially some outliers which have quite high price, as shown by the points shown beyond the “whiskers” of the boxplots.

```{r points.vs.price2}
#scatter plot
ggplot(data = data, aes(x = price, y = bnpoints)) +
  geom_point(position = position_jitter()) +
  scale_y_discrete("Points", labels = c("0" = "Good", "1" = "Excellent")) +
  labs(x = "Price", y = "Points", title = "The scatter plot of Price against Points") 
```

From the above scatter plot, we can more intuitively see that the prices of good wines are mostly concentrated in the range of 0-50, while the prices of excellent wines are higher and more widely distributed.

```{r points.vs.year1}
#The boxplot of points against year
ggplot(data = data, aes(x = bnpoints, y = year, group = bnpoints)) +
  geom_boxplot(fill = c("blue","orange")) +
  labs(x = "Points", y = "Year", title = "The boxplot of year grouped by points") + 
  scale_x_discrete("Points", labels = c("0" = "Good", "1" = "Excellent")) +
  theme(legend.position = "none") 
```

We can see that Wines with more recent vintages are of slightly better quality than wines with farther vintages. There are also potentially ten outliers (five "Good" and five "Excellent") which have very long vintages can be seen in the boxplots. Next, we plot a scatter plot to try to better observe the relationship between both of them.

```{r points.vs.year2}
#scatter plot
ggplot(data = data, aes(x = year, y = bnpoints)) +
  geom_point(position = position_jitter()) +
  scale_y_discrete("Points", labels = c("0" = "Good", "1" = "Excellent")) +
  labs(x = "Year", y = "Points", title = "The scatter plot of Year against Points") 
```

There is no obvious relationship between years and points from the above scatter plot, we will further explore their relationship in the next section. The 25 country of origins are presented in the following pie chart.

```{r country}
#The pie chart
ggplot(data = data, aes(x = factor(1), fill = country))+
  geom_bar(width = 2)+
  coord_polar("y")
```

As can be seen from the pie chart above, wines originating in the US account for nearly half of the total observations.

# Formal Data Analysis {#sec:FDA}

## Generalised linear models

To begin to analyse the wine data formally, we fit the following linear model to the data.

\begin{align}
\nonumber \ln(\frac{p}{1-p}) &= \widehat{\alpha} + \widehat\beta_{\mbox{1}} \cdot {countryAustralia}_{\mbox{i}} + \widehat\beta_{\mbox{2}} \cdot {countryAustria}_{\mbox{i}} +~...~+ \widehat\beta_{\mbox{24}} \cdot {countryUS}_{\mbox{i}}\\
\nonumber &~~~+ \widehat\beta_{\mbox{25}} \cdot {price}_{\mbox{i}} + \widehat\beta_{\mbox{26}} \cdot {year}_{\mbox{i}} + \epsilon_{\mbox{i}}, ~~~~ \epsilon_{\mbox{i}} \sim N(0,\sigma^2),
\end{align}

where

$\bullet$ $p =$ Prob(Excellent) and $1 - p =$ Prob(Good);

$\bullet$ $\widehat\alpha$ is the intercept;

$\bullet$ $\widehat\beta_{\mbox{1}}$, $\widehat\beta_{\mbox{2}}$, ... ,$\widehat\beta_{\mbox{24}}$ are the coefficient for countries;

$\bullet$ $\widehat\beta_{\mbox{25}}$ is the coefficient for price;

$\bullet$ $\widehat\beta_{\mbox{26}}$ is the coefficient for year; and

$\bullet$ $\epsilon_{\mbox{i}}$ is the $i^{\mbox{th}}$ random error component.

At first, fitting all of the variables in the model1, and the output is shown below. 

```{r full.model}
#model1:bnpoints ~ country + price + year
model1 <- glm(bnpoints ~ country + price + year,
             data=data, family=binomial(link = "logit"))
model1%>%
  summary()
```

When model is fitted to the data, the estimates of intercept $\alpha$ and coefficient $\beta$ are returned and the AIC in model1 is 1634.7. In order to decide whether the above variables should be retained, analysis of deviance table are presented as follow.

```{r checking}
#Inference 
#analysis of deviance table
anova(model1, test = "Chi") 
# %>%kabel()
#the p-value of the year is not significant, trying to fit a model omitting year variables
```

It can be seen that the p-value of the year is not significant, as shown in the previous scatter plot in Section \ref{#sec:EDA}. So we plan to fit another model by removing year in next steps. Linear model2 is built as following,

\begin{align}
\nonumber \ln(\frac{p}{1-p}) &= \widehat{\alpha} + \widehat\beta_{\mbox{1}} \cdot {countryAustralia}_{\mbox{i}} + \widehat\beta_{\mbox{2}} \cdot {countryAustria}_{\mbox{i}} +~...~+ \widehat\beta_{\mbox{24}} \cdot {countryUS}_{\mbox{i}}\\
\nonumber &~~~+ \widehat\beta_{\mbox{25}} \cdot {price}_{\mbox{i}} + \epsilon_{\mbox{i}}, ~~~~ \epsilon_{\mbox{i}} \sim N(0,\sigma^2),
\end{align}

Next, fitting variables country and price in the model2. 

```{r model2}
#the model2: bnpoints ~ price + country
model2 <- glm(bnpoints ~ country + price, data = data, family = binomial(link = "logit"))
model2%>%
  summary()
```

The output shows that country of origin and the price, that is, the cost for a bottle of wine, influence whether the number of points awarded is greater than 90.

## Price against the probability of being excellent wine

In this step, we add the variable `Probs` to the data, which is the probability of being excellent wine. The estimated probabilities can also produced by age as follows:

```{r estimates}
#adding the predict value
data.noyear <- data %>%
  select(country, price, bnpoints) %>%
  mutate(probs = fitted(model2))

ggplot(data = data.noyear, aes(x = price, y = probs)) +
  geom_smooth(method="glm", 
              method.args = list(family="binomial"), 
              se = FALSE) +
  labs(x = "price", y = "Probability of being Excellent wine")
```

From the above plot, it can be clearly seen that as the price rises, the probability of being excellent wine is gradually increasing. This is consistent with the conclusion that price influences the points of wine, which is obtained in the previous report.

## ROC and AUC

In this section, we access the predictive power of the selected model2 by looking at the ROC curve and AUC value. The ROC curve for the model fitted to our data as follow:

```{r ROC}
#ROC plot 
#goodness of the model
pro.noyear <- predict(model2, data, type = "response")
predict.noyear <- prediction(pro.noyear, data$bnpoints)
per.noyear <- performance(predict.noyear, measure = "tpr", x.measure = "fpr")
plot(per.noyear, col = "red", title = "ROC plot")
```

```{r AUC}
#outputting the AUC
auc.noyear <- performance(predict.noyear, measure = "auc")
auc.noyear@y.values
```

And the area under the ROC curve, known as AUC, in our model is 0.8420448 which is greater than 0.5. It is indicated that the model performs better than a random guess.

## DALEX model

```{r importance, eval = FALSE, message = FALSE, warning = FALSE }
#DELEX model to explain the importance of the variables
#classifying the training dataset and test dataset
wine <- as_tibble(data)
str(wine)
id <- sample(2, nrow(wine), replace = TRUE, prob = c(0.7, 0.3))
winetrain <- wine[id == 1,]
winetest <- wine[id == 2,]
p_fun <- function(object, newdata){
  predict(object, newdata = newdata, type = "prob")[,2]
}

#building the full model using GLM
bnpoints_glm <- train(bnpoints ~ country + price + year, data = winetrain,
                      method = "glm", family = "binomial")
#explaining the model

yTest <- as.numeric(as.character(winetest$bnpoints))

explainer_glm <- DALEX::explain(bnpoints_glm, label = "glm", 
                                data = winetest, y = yTest,
                                predict_function = p_fun)
#the importance analysis of variables
importance_glm <- variable_importance(explainer_glm, loss_function = loss_root_mean_square)
plot(importance_glm)
```


# Conclusions {#sec:Conc}

=======
---
title: "GLM project"
author: "Group 26"
date: "7/19/2021"
output:
  pdf_document:
    latex_engine: pdflatex
    number_sections: yes
    keep_tex: true
  html_document:
    df_print: paged
fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE, comment = NA)
```

```{r libraries,echo = FALSE ,include=FALSE, message=FALSE}
library(tidyverse)
library(moderndive)
library(gapminder)
library(sjPlot)
library(stats)
library(jtools)
library(dplyr)
library(tidyr)
library(stringr)
library(purrr)
library(readr)
library(ROCR)
library(lattice)
library(caret)
library(DALEX)
```

```{r data}
#import the data
data <- read.csv("dataset26.csv")
```

# Introduction {#sec:Intro}

The ratings (the number of points awarded for the wine on a scale of 1-100) on a variety of wines are very different, due to many factors, such as different country, price, province, title, variety, winery, etc. This report will present numerical and graphical summaries of properties of wine and use a Generalised Linear Model (GLM) to explore the factors influencing the number of points awarded.

## Data sources & research questions

All the data comes from the WineEnthusiast. In the dataset, 3 explanatory variables were selected to investigate which properties of wine influence whether the number of points awarded is greater than 90. The variables are:

- `country`: country of origin;
- `price`: the cost for a bottle of wine;
- `year`: extract from the `title` of the wine review in Section \ref{sec:EDA}.

Our team select the `bnpoints` as the response variable, which is transformed from the `points` in Section  \ref{sec:EDA}.

# Exploratory Data Analysis {#sec:EDA}

Before starting to analyze the data, we first generate two new variables `year` and `bnpoints` based on the original dataset. Among them, `year` is extracted from the variable `title`, and `bnpoints` is a binary variable. Wines with a score greater than 90 are recorded as 1, and wines with a score less than or equal to 90 are recorded as 0. Next, delete outliers and missing values.

```{r data.processing}
data <- data[,2:8]  #deleting the first line

#glimpse data 
str(data)
# data processing 
# trans to binary
data$bnpoints[data$points > 90] <- 1 
data$bnpoints[data$points <= 90] <- 0
#converting the type of bnpoints to factor
data$bnpoints <- as.factor(data$bnpoints)

#extract year from title
data$year <- data$title
data$year <- str_replace_all(data$year, "[[:punct:]]", " ")
data$year <- str_extract(data$year,"[0-9]{4}") #extracting year with four digits 

#omiting abnormal year
data <- data %>%
  filter(year > 1900)
#converting the type of year from chr. to intger
data$year <- as.integer(data$year)

#omitting the observations with missing variables 
data <- na.omit(data)
```

After removing missing data, there are 1794 types of wine to analyze. In this report, if points is 1, the quality of the wine is Excellent; if points is 0, the quality of the wine is Good. The relationship between points and prices and the relationship between points and years are presented in the following boxplots and scatter plots, respectively.

```{r points.vs.price1}
#The boxplot of points against price
ggplot(data = data, aes(x = bnpoints, y = price, group = bnpoints)) +
  geom_boxplot(fill = c("pink", "yellow")) +
  labs(x = "Points", y = "Price", title = "The boxplot of price grouped by points") + 
  scale_x_discrete("Points", labels = c("0" = "Good", "1" = "Excellent")) +
  theme(legend.position = "none") 
```

The above boxplots show that higher-priced wines are of higher quality, in general, compared to the lower-priced wines and that the prices of wines are widely distributed. There are also potentially some outliers which have quite high price, as shown by the points shown beyond the “whiskers” of the boxplots.

```{r points.vs.price2}
#scatter plot
ggplot(data = data, aes(x = price, y = bnpoints)) +
  geom_point(position = position_jitter()) +
  scale_y_discrete("Points", labels = c("0" = "Good", "1" = "Excellent")) +
  labs(x = "Price", y = "Points", title = "The scatter plot of Price against Points") 
```

From the above scatter plot, we can more intuitively see that the prices of good wines are mostly concentrated in the range of 0-50, while the prices of excellent wines are higher and more widely distributed.

```{r points.vs.year1}
#The boxplot of points against year
ggplot(data = data, aes(x = bnpoints, y = year, group = bnpoints)) +
  geom_boxplot(fill = c("blue","orange")) +
  labs(x = "Points", y = "Year", title = "The boxplot of year grouped by points") + 
  scale_x_discrete("Points", labels = c("0" = "Good", "1" = "Excellent")) +
  theme(legend.position = "none") 
```

We can see that Wines with more recent vintages are of slightly better quality than wines with farther vintages. There are also potentially ten outliers (five "Good" and five "Excellent") which have very long vintages can be seen in the boxplots. Next, we plot a scatter plot to try to better observe the relationship between both of them.

```{r points.vs.year2}
#scatter plot
ggplot(data = data, aes(x = year, y = bnpoints)) +
  geom_point(position = position_jitter()) +
  scale_y_discrete("Points", labels = c("0" = "Good", "1" = "Excellent")) +
  labs(x = "Year", y = "Points", title = "The scatter plot of Year against Points") 
```

There is no obvious relationship between years and points from the above scatter plot, we will further explore their relationship in the next section. The 25 country of origins are presented in the following pie chart.

```{r country}
#The pie chart
ggplot(data = data, aes(x = factor(1), fill = country))+
  geom_bar(width = 2)+
  coord_polar("y")
```

As can be seen from the pie chart above, wines originating in the US account for nearly half of the total observations.

# Formal Data Analysis {#sec:FDA}

## Generalised linear models

To begin to analyse the wine data formally, we fit the following linear model to the data and choose Argentina as the baseline category of countries.

$$\ln(\frac{p}{1-p}) = \alpha + \beta_1 \cdot \mathbb{I}_{Australia} + \beta_2 \cdot \mathbb{I}_{Austria} +~...~+ \beta_{24} \cdot \mathbb{I}_{US} + \beta_{25} \cdot X_{price} + \beta_{26} \cdot X_{year} + \epsilon, ~~~~ \epsilon \sim N(0,\sigma^2),$$

where

$\bullet$ $p = Prob(Excellent)$ and $1 - p = Prob(Good)$;

$\bullet$ $\alpha$ is the intercept;

$\bullet$ $\beta_1$, $\beta_2$, ... ,$\beta_{24}$ are the coefficient for countries;

$\bullet$ $\beta_{25}$ is the coefficient for price;

$\bullet$ $\beta_{26}$ is the coefficient for year; and

$\bullet$ $\epsilon$ is the random error component.

At first, fitting all of the variables in the model1, and the output is shown below. 

```{r full.model}
#model1:bnpoints ~ country + price + year
model1 <- glm(bnpoints ~ country + price + year,
             data=data, family=binomial(link = "logit"))
model1%>%
  summary()
```

When model is fitted to the data, the estimates of intercept $\alpha$ and coefficient $\beta$ are returned and the AIC in model1 is 1634.7. In order to decide whether the above variables should be retained, analysis of deviance table are presented as follow.

```{r checking}
#Inference 
#analysis of deviance table
anova(model1, test = "Chi") 
# %>%kabel()
#the p-value of the year is not significant, trying to fit a model omitting year variables
```

It can be seen that the p-value of the year is not significant, as shown in the previous scatter plot in Section \ref{sec:EDA}. So we plan to fit another model by removing year in next steps. Linear model2 is built as following,

$$\ln(\frac{p}{1-p}) = \alpha + \beta_1 \cdot \mathbb{I}_{Australia} + \beta_2 \cdot \mathbb{I}_{Austria} +~...~+ \beta_{24} \cdot \mathbb{I}_{US} + \beta_{25} \cdot X_{price} + \epsilon, ~~~~ \epsilon \sim N(0,\sigma^2).$$

Next, fitting variables country and price in the model2. 

```{r model2}
#the model2: bnpoints ~ price + country
model2 <- glm(bnpoints ~ country + price, data = data, family = binomial(link = "logit"))
model2%>%
  summary()
```

```{r CI}
plot_model(model2, show.values = TRUE, transform = NULL,
           title = "Log-Odds (instructor)", show.p = FALSE)
```

The output above shows that the p-values of intercept, Austria, Germany and price are significant. Therefore, country of origin and the price, that is, the cost for a bottle of wine, influence whether the number of points awarded is greater than 90.

## Price against the probability of being excellent wine

In this step, we add the variable `Probs` to the data, which is the probability of being excellent wine. The estimated probabilities can also produced by age as follows:

```{r estimates}
#adding the predict value
data.noyear <- data %>%
  select(country, price, bnpoints) %>%
  mutate(probs = fitted(model2))

ggplot(data = data.noyear, aes(x = price, y = probs)) +
  geom_smooth(method="glm", 
              method.args = list(family="binomial"), 
              se = FALSE) +
  labs(x = "price", y = "Probability of being Excellent wine")
```

From the above plot, it can be clearly seen that as the price rises, the probability of being excellent wine is gradually increasing. This is consistent with the conclusion that price influences the points of wine, which is obtained in the previous report.

## ROC and AUC

In this section, we access the predictive power of the selected model2, which contains two explanatory variables `country` and `price`, by looking at the ROC curve and AUC value. The ROC curve for the model fitted to our data as follow:

```{r ROC}
#ROC plot 
#goodness of the model
pro.noyear <- predict(model2, data, type = "response")
predict.noyear <- prediction(pro.noyear, data$bnpoints)
per.noyear <- performance(predict.noyear, measure = "tpr", x.measure = "fpr")
plot(per.noyear, col = "red", title = "ROC plot")
```

```{r AUC}
#outputting the AUC
auc.noyear <- performance(predict.noyear, measure = "auc")
auc.noyear@y.values
```

And the area under the ROC curve, known as AUC, in our model is 0.8420448 which is greater than 0.5. It is indicated that the model performs better than a random guess.

## DELEX model

In this section, we divide the data set into training set and test set and construct DELEX model via package caret and DELEX, in order to explain the importance of the variables. In the model, `country`, `price` and `year` are explanatory variables; `points` are response variable. The loss function applied in the code is the Root Mean Square Error (RMSE), which is interpreted as how much the absence of this variable will affect the predicted value of the response variable.

```{r importance, message = FALSE, warning = FALSE }
#DELEX model to explain the importance of the variables
#classifying the training dataset and test dataset
wine <- as_tibble(data)
str(wine)
id <- sample(2, nrow(wine), replace = TRUE, prob = c(0.7, 0.3))
winetrain <- wine[id == 1,]
winetest <- wine[id == 2,]
p_fun <- function(object, newdata){
  predict(object, newdata = newdata, type = "prob")[,2]
}

#building the full model using GLM
bnpoints_glm <- train(bnpoints ~ country + price + year, data = winetrain,
                      method = "glm", family = "binomial")
#explaining the model

yTest <- as.numeric(as.character(winetest$bnpoints))

explainer_glm <- DALEX::explain(bnpoints_glm, label = "glm", 
                                data = winetest, y = yTest,
                                predict_function = p_fun)
#the importance analysis of variables
importance_glm <- variable_importance(explainer_glm, loss_function = loss_root_mean_square)
plot(importance_glm)
```

Obviously, `price` and `country` have a greater influence on the `points`, especially `price`, while the `year` has a small impact on the `points`.

# Conclusion and Further Task {#sec:Conc}

## Conclusion

In summary, country and price influence whether the number of points awarded is greater than 90. The increase in price is positively associated with points, and points are also  influenced by countries. For example, wines of origin in Austria and Germany are of better quality

## Further task

Since the origins of different wines are widely distributed, in this report we only specify the geographic location to the country. the `country` is one of the model explanatory variable, while the `province` and `winery` are not included. In the next work, the geographic location can be more detailed, and further explore the influence of geographic location such as latitude and longitude and natural conditions on the quality of wine.
>>>>>>> 070644e42fae4fa3b356414028e274b9f1d98937
